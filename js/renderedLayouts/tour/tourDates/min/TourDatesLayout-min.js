define(["jquery","underscore","backbone","marionette","moment","app","event.aggregator","extensions/marionette/views/RenderedLayout","util/uriUtil","util/tourDetailUtil","util/objectUtil","util/dateUtil","services/tourService","views/tour/tourDates/TourDateYearListView","views/tour/tourDates/yearTabs/YearTabListView","collections/tour/tourDates/TourDateCollection","collections/tour/tourDates/TourDatesByYearCollection","collections/tour/tourDates/TourDatesByMonthCollection","models/tour/tourDates/TourDatesByMonthModel","models/tour/tourDates/TourDatesByYearModel"],function($,e,t,a,n,o,r,i,s,l,d,c,u,f,h,m,g,y,v,D){var p=2e3,b=new Date,w=i.extend({el:"#dates_section_container",events:{"click .itinerary-button":"changeDate","shown.bs.tab":"renderScrollText"},ui:{$tabs:".tab-content"},regions:{tabHeaders:".year-tabs",tabContent:".tab-content"},changeDate:function(e){e.preventDefault(),this.startItineraryAnimation(),this.setPackageDateRoute($(e.currentTarget).attr("value")),this.setItineraryButton(e)},initialize:function(){var e=this;r.on("pageEnteredWithDate",function(t){for(var a,n=$("#dates_section_container .itinerary-button"),o=0;o<n.length;o++)if(n[o].getAttribute("value")==t){a=n[o];break}a?e.setItineraryButton(a):console.log("TourDatesLayout- initialize: Date GUID matched no available Itinerary Button.")})},setItineraryButton:function(e){var t=this.ui.$tabs;t.find(".dates-pane").each(function(){var e=t.find(".btn-default");e.hide(),e.siblings().closest("#viewItineraryButton").show()});var a;a=$(e.currentTarget?e.currentTarget:e);var n=a.closest("#viewItineraryButton"),o=n.siblings().closest("#selectedItineraryButton");n.hide(),o.show(),o.prop("disabled",!0),this.setItineraryHeader(n)},setItineraryHeader:function(e){var t=o.dictionary.get("common.Misc.For"),a=o.dictionary.get("tourRelated.FreeFormText.YourItinerary"),n=e.attr("startdate"),r=e.attr("enddate"),i=c.getMomentDateType(n).format("ll")+" - "+c.getMomentDateType(r).format("ll"),s=$("#itinerary_section"),l=s.find("header").find("h2").find("span");l.text(a+" "+t+" "+i)},setPackageDateRoute:function(e){var t=this;d.isNullOrEmpty(e)||(this.setSelectedDate(e),r.on("tourDetailsRequestComplete",function(){var e=p-(Date.now()-b);e=e>0?e:0,setTimeout(function(){if(t.endItineraryAnimation(),!o.isBooking){var e=$("#yourItinerary").find(".expanded");e&&e.length>0&&t.openItineraryDetails()}},e)}))},openItineraryDetails:function(){var e=$("#itineraryDetailsViewMore"),t=e.find("span"),a=e.closest(".container"),n=e.siblings(".section").find(".expanded");t.text("Close"),$("body, html").animate({scrollTop:a.offset().top},function(){n.slideDown(),e.hasClass("close")||e.toggleClass("close")})},setSelectedDate:function(t){if(d.isNullOrEmpty(t))u.getDefaultTourDetails();else{var a=e.find($("input[name=date]:radio"),function(e){var a=$(e);return a.val()==t});if(!d.isNullOrEmpty(a)){var n=$(a);n.prop("checked",!0)}this.addToBookNowHref(t),this.addToEmailButton(t);var r={packageDateId:t,currentItemId:o.siteSettings.currentItemId};u.getTourDetails(r)}o.mobile||$("#ready_to_book_section").show()},addToBookNowHref:function(e){var t=$("#tour-hero-book-now").attr("href");if(void 0!=t&&!d.isNullOrEmpty(t)){var a="?";if(t.indexOf("?")>-1&&(a="&"),t.indexOf("packagedate")>-1&&t.indexOf(e)<=-1){var n=/packagedate={[A-Za-z0-9-]*}/i,o=t.replace(n,"packagedate="+e);$("#tour-hero-book-now").prop("href",o)}else t.indexOf("packagedate")<=-1&&(t=t+a+"packagedate="+e,$("#tour-hero-book-now").prop("href",t))}},addToEmailButton:function(e){d.isNullOrEmpty(e)||$("#emailButton").attr("value",e)},buildTourDateSelectors:function(e){var t=this,a=e.length,n=this.getYearsCollection(e);this.tabHeaders.show(new h({collection:n})),this.tabContent.show(new f({collection:n})),l.generatePickFromText(a),this.renderScrollText(),this.endLoadingAnimation()},renderScrollText:function(){var e=$(".dates-pane.tab-pane.active");0!=e.length&&(e.hasScrollBar()?$(".scroll-me").addClass("show-scroll-me"):$(".scroll-me").removeClass("show-scroll-me"))},getYearsCollection:function(e){var t=new g;return e.models.forEach(function(e){var a=n(e.get("startDate")).toDate(),o=a.getFullYear(),r=a.getMonth(),i=c.getMonthName(e.get("startDate")),s=t.findWhere({year:o});if(void 0!=s){var l=s.get("datesByMonth"),d=l.findWhere({monthId:r});void 0!=d?d.set("dates",d.get("dates").add(e)):s.set("datesByMonth",l.add(new v({year:o,monthId:r,monthName:i,dates:new m(e)})))}else t.add(new D({year:o,datesByMonth:new y(new v({year:o,monthId:r,monthName:i,dates:new m(e)}))}))}),t},endLoadingAnimation:function(){var e=$("#date-section-loader"),t=e.parent(".section-loader-container");e.fadeOut(),t.removeClass("loading")},startItineraryAnimation:function(){b=Date.now();var e=$("#itinerary-loader"),t=e.parent(".section-loader-container");e.fadeIn(),t.addClass("loading-action")},endItineraryAnimation:function(){var e=$("#itinerary-loader"),t=e.parent(".section-loader-container");e.fadeOut(),t.removeClass("loading-action")}});return w});