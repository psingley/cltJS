define(["jquery","underscore","backbone","marionette","app","renderedLayouts/newsletter/BaseNewsletterLayout","views/validation/ErrorView","views/validation/SuccessView","util/objectUtil","util/validationUtil","goalsUtil"],function($,e,t,i,s,n,a,r,o,l,c){var u=n.extend({el:"#newsletter-modal",events:{"click #newsletterSignUpButton":"submitForm"},regions:{messagesRegion:"#newsletter-errorbox"},ui:{$newsletterEmail:"#email",$newsletterConfirmEmail:"#confirm-email",$newsletterMessage:"#newsletterMessage",$optIn:".optIn"},initialize:function(){this.preventCopyPaste(this.ui.$newsletterConfirmEmail),s.siteIds.Collette===s.siteSettings.siteId&&"en"===s.siteSettings.siteLanguage&&this.ui.$optIn.attr("checked",!0)},submitForm:function(e){e.preventDefault();var t=this.ui.$newsletterEmail.val(),i=this.ui.$newsletterConfirmEmail.val(),n=this.ui.$newsletterMessage.val(),a=this.ui.$optIn.is(":checked"),r=[],o=s.dictionary.get("common.FormValidations.OptInNotCheckedEmail"),c=s.dictionary.get("common.FormValidations.EmailAlreadyExists"),u=this;if(null!=n&&""!=n)return!1;a||r.push(o);var d=l.validateEmail(t,i);r=r.concat(d),r.length>0?this.finalizeTransaction(r,t):this.checkEmailExists(t).done(function(e){var i=e.d.toLowerCase()==="true".toLowerCase();i&&r.push(c),u.finalizeTransaction(r,t)})},finalizeTransaction:function(e,t){var i=this;if(0===e.length){this.messagesRegion.close();try{dataLayer.push({event:"gaEvent",eventCategory:"Newsletter",eventAction:"Email",eventLabel:"Receive Newsletter Brochure Page"})}catch(s){console.log(s)}this.logNewsletterTransaction(),i.subscribeEmailAddress(t,this.ui.$optIn.is(":checked"))}else{var n=new a(e);this.messagesRegion.show(n)}},subscribeEmailAddress:function(e,t){var i=this,n=s.siteSettings.currentItemId,a="";$(this.el).length>0&&(a=$(this.el).data("datasourceid"));var o=JSON.stringify({emailAddress:e,optIn:t,currentItemId:n,signupDataSourceId:a});$.ajax({url:"/Services/Brochures/NewsletterService.asmx/Subscribe",contentType:"application/json; charset=utf-8",dataType:"json",data:o,type:"POST",success:function(e){var t=new r(["Thank you for successfully signing up!"]);i.messagesRegion.show(t),s.Newsletter.cookieValue=e.d,s.Newsletter.stop()},error:function(){console.log("NewsletterService call failed: Subscribe")}}),c.emailSignup(e)}});return u});